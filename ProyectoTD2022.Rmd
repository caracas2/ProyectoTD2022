---
title: "ProyectoTD2022"
author: ' Carles Vicent Adam Castañer, Ana González Mandler, Arnau Monzó Ferragut,
  Ivan Alexandrov y Amparo Galvez Vilar. GRUPO F'
date:  "`r Sys.Date()`"  # Fecha del día actual
output:
  html_document:
    echo: yes
    number_sections: no
    theme: lumen
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: no
---

## INSTALACIÓN LIBRERÍAS

Lo primero que haremos será llamar a todas las librerías necesarias que vamos a utilizar en este trabajo.

```{r include=F}
# Especificamos las librerías necesarias en esta lista
packages = c("stringr", "ggplot2","tidyr","dplyr","readr", "plotly", "lubridate")# use this function to check if each package is on the local machine
# if a package is installed, it will be loaded
# if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
    library(x, character.only = TRUE)
  }
})
# verify they are loaded
search()

```

## PRIMERA FASE:

Posteriormente cargamos los 14 ficheros de datos

```{r}
files <- list.files(path = "data/", full.names = T, pattern = "csv", recursive = TRUE)

```

Fusionamos los datos en un único data frame

```{r}
for (file in files){

      

  # if the merged dataset doesn't exist, create it

  if (!exists("dataset")){

    dataset <- read.table(file, header=TRUE, sep=",")

  }

  

  # if the merged dataset does exist, append to it

  if (exists("dataset")){

    temp_dataset <-read.table(file, header=TRUE, sep=",")

    dataset<-rbind(dataset, temp_dataset)

    rm(temp_dataset)

  }

}
```

## SEGUNDA FASE:

Acondicionamos los datos para que se correspondan con un tidy dataset.

```{r}
df <- dataset %>% pivot_longer(cols = starts_with("LA"), names_to = "Periodo", values_to = "Valores", names_prefix = "/")

df$dateObserved <- as.Date(df$dateObserved)
```

Eliminamos columnas que son irrelevantes para este proyecto

```{r}
df <- df %>% select(-c(ï.._id, fiwareServicePath, entityType, recvTime))

```

Cambiamos el nombre de las columnas recvTime y dateObservation para que sea mas fácil realizar las siguientes operaciones.

```{r}
df <- df %>% rename(FechaObservacion = dateObserved) %>% rename(IdEntidad = entityId)

df_tidy <- df %>%  
   
  mutate(IdEntidad = ifelse(IdEntidad == "T248677-daily" , "VivChafCadz", IdEntidad))%>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248671-daily" , " Cadiz16 ", IdEntidad))%>%
  mutate(IdEntidad = ifelse(IdEntidad == "T248670-daily" , "CarlCervChaf", IdEntidad))%>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248655-daily", "Cadiz3 ", IdEntidad))%>%
  mutate(IdEntidad = ifelse(IdEntidad == "T248678-daily" , "CarlCerv34 ", IdEntidad)) %>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248682-daily" , "Cuba3", IdEntidad)) %>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248682-daily" , "Cuba3", IdEntidad)) %>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248669-daily" , "DoctorSerrano21", IdEntidad))%>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248676-daily" , "SalvAbrilChaf", IdEntidad))%>% 
  mutate(IdEntidad= ifelse(IdEntidad == "T248683-daily", "Sueca2" , IdEntidad))%>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248680-daily", "Sueca32", IdEntidad))%>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248652-daily","SuecaEsqDenia",  IdEntidad))%>% 
  mutate(IdEntidad = ifelse(IdEntidad == "T248684-daily","Sueca61", IdEntidad))%>%
  mutate(IdEntidad = ifelse(IdEntidad == "T248672-daily" , "PuertoRico21", IdEntidad))%>%
  mutate(IdEntidad = ifelse(IdEntidad == "T248661-daily" , "GeneralPrim",  IdEntidad))
```

A continuacíon hemos planteado varias preguntas las cuales más adelante responderemos.

## PREGUNTAS PROPUESTAS

1.  ¿Que calle es la mas ruidosa? ¿Y la que menos?

2.  ¿Que mes del año tiene el maximo indice de ruido? ¿Y el minimo?

3.  Calcula la media de los dos meses del anterior apartado.

4.  ¿Como afecto el confinamiento?

5.  ¿Como varía el ruido dependiendo de si es lunes o sábado?

LAeq_d \<- 7-19 LAeq_den \<- indice entre los tres dia, tarde, noche LAeq_e \<- 19-23 LAeq_n \<- 23-7 LAeq \<- periodo estable de 1 min

### PREGUNTA 1: ¿Cual es la calle más ruidosa?¿Y la que menos?
Calculamos en primer lugar la calle más ruidosa
```{r}

df_tidy%>%
  filter (Valores == max(Valores, na.rm = TRUE )) %>% 
  select(c(IdEntidad, Valores))

```
En segundo lugar, calculamos la calle menos ruidosa

```{r}

df_tidy%>%
  filter (Valores == min(Valores, na.rm = TRUE )) %>% 
  select(c(IdEntidad, Valores))


```

### PREGUNTA 2: ¿Que mes del año tiene el máximo indice de ruido? ¿Y el mínimo?**

Para contestar a la pregunta planteada, analizaremos las variables FechaObservacion, que contiene la fecha de la observacion como bien indica su nombre, y la variable Valores que contiene los indices de ruido de cada observacion. Para tener una mejor representacion de cada mes, agruparemos la variable FechaObservacion por el mes, y haremos la media de los Valores (indices de ruido) que le corresponden.

```{r}

library(lubridate)

df_meses <- df_tidy
df_meses$Month<-months(df_meses$FechaObservacion)
df_meses$Year<-format(df_meses$FechaObservacion,format="%y")


is.na(df_meses) <- sapply(df_meses, is.infinite)

media_meses <- df_meses %>% filter(!is.na(Valores)) %>% group_by(Month) %>% summarise(media_ruido = mean(Valores))
head(media_meses)
#aggregate(Valores~Month,df_meses,mean)

```

Ahora que tenemos todos los datos limpiados y filtrados, podemos proceder a sacar las graficas y determinar los meses con mayor y menor indice de ruido:

```{r}
library(scales)

media_meses %>% ggplot(aes(x = Month, y = media_ruido, group = 1), colour = Month) + geom_line() + geom_point() + labs(x = "Meses", y = "Indice Ruido", title = "Indice Ruido por Mes") + theme(axis.text.x=element_text(angle=45, hjust=1), panel.background = element_rect(fill = "lightblue")) + geom_hline(yintercept = mean(media_meses$media_ruido), color="red", lty="dashed", size = 1)

media_meses %>% ggplot(aes(x = Month, y = media_ruido, fill = Month, ratio = 50)) + geom_bar(stat = "identity") + labs(x = "Meses", y = "Indice Ruido", title = "Indice Ruido por Mes") +  theme(axis.text.x=element_text(angle=45, hjust=1)) + scale_y_continuous(limits = c(55,65), oob = rescale_none) + geom_hline(yintercept = mean(media_meses$media_ruido), color="black", lty="dashed", size = 1.25)
                                                                                                                                                                                                                                                      



```

En las graficas se ve claramente que el mes con más indice de ruido es Marzo, y el mes con el menor indice es Enero, además en amnos gráfico hemos incluido una linea roja que representa el valor medio de ruido de todos los meses. Aun asi, para estar seguros lo comprobaremos de la siguiente manera:

```{r}
#Mayor indice de ruido:
maximo <- filter(media_meses, media_ruido == max(media_ruido))
maximo

#Menor indice de ruido:
minimo <- filter(media_meses, media_ruido == min(media_ruido))
minimo

#Diferencia en numero real:
maximo$media_ruido - minimo$media_ruido

#Diferencia en porcentaje:
((maximo$media_ruido / minimo$media_ruido)*100)-100

#Media de indicee de ruido por mes:
mean(media_meses$media_ruido) #60.53897
```

Para concluir, podemos afirmar que el mayor indice de ruido lo tiene el mes de Marzo (63.43801). Una explicación lógica a esta conclusión podría ser que las Falls de Valencia se celebran ese mismo mes y por tanto el ruido sobrepasa la media. El mes de enero resulta tener el menor indice de ruido (58.65435), que seguramente sea debido a que segun los estudios meteorológicos es el mes más frío en España. Como dato adiccional, hemos calculado la diferencia entre los dos datos obtenidos, que es 4.783661 o bien un 8.15568%.

Por último debemos mencionar que el indice de ruido de Enero esta por debajo de la media de ruido (60.63897), en cambio el indice de ruido de Marzo esta casi 4 unidades por encima.

### PREGUNTA 5: ¿Como varía el ruido dependiendo de si es lunes o sábado?

Para empezar a responder a esta cuestión deberemos seleccionar todos los lunes y todos los viernes. Para ello utlizaremos la función 'filter'.

```{r}
lunes <- df_tidy %>% filter(wday(FechaObservacion)=='2')
sabado <- df_tidy %>% filter(wday(FechaObservacion)=='7')
```

A continuación, cambiaremos el formato de la fecha para que más tarde represntarlo sea más fácil.

```{r}
for (x in lunes){
  lunes$FechaObservacion = 'Lunes' 
}

for (x in sabado){
  sabado$FechaObservacion = 'Sábado' 
}
```

Juntamos los dos dataframes:

```{r}
junto <- rbind(lunes, sabado)
```

Por último, representamos el dataframe y vemos las diferencias.

```{r}
junto %>% ggplot(aes(x=FechaObservacion, y = Valores, color= Valores)) + geom_point() + labs(title = 'Pregunta 5', x = 'Fecha Observación', y = 'Intensidad ruido')
```

Gracias al gráfico podemos ver que los lunes la intensidad de ruido es mucho más pequeña a la de los viernes. Esto se debe al fin de semana, ya que los sabados la gente sale más por la calle tanto a dar un paseo como a un bar a tomar algo. En cambio, los lunes la gente trabaja y la mayor parte del dia se lo pasan dentro de una oficina, por tanto no haygran concentración de gente en la calle como pasa los sábados.
